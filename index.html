// Firestore Rules（全文置換：P1＝全ログインユーザー閲覧を実現）
//
// 重要：このルールは「全ログインユーザーが events/match を読める」設計です。
// 書き込みは原則「作成者（teamId==uid）だけ」に制限して事故を防ぎます。
// ※必要に応じて「match 作成/更新/削除は管理者のみ」は維持

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------
    // helpers
    // ----------------------
    function isAuthed() { return request.auth != null; }
    function myUid() { return request.auth.uid; }

    function isGlobalAdmin() {
      return isAuthed()
        && exists(/databases/$(database)/documents/admins/$(myUid()));
    }

    // 試合参加者（入力できる人）判定
    function isParticipant(matchId) {
      return isAuthed()
        && exists(/databases/$(database)/documents/matches/$(matchId)/memberships/$(myUid()));
    }

    // ----------------------
    // admins
    // ----------------------
    match /admins/{uid} {
      allow read: if isAuthed() && myUid() == uid;
      allow write: if false;
    }

    // ----------------------
    // users（emailLower で検索するため）
    // ----------------------
    match /users/{uid} {
      allow read: if isAuthed();                 // 管理者のメール検索のため read を許可
      allow create, update: if isAuthed() && myUid() == uid; // 自分だけ書ける
      allow delete: if false;
    }

    // ----------------------
    // joinCodes
    // ----------------------
    match /joinCodes/{code} {
      allow read: if isAuthed();
      allow create, update, delete: if isGlobalAdmin();
    }

    // ----------------------
    // invites
    //  - Admin: CRUD
    //  - Team: 自分宛のみ read
    // ----------------------
    match /invites/{inviteId} {
      allow read, create, update, delete: if isGlobalAdmin();

      allow read: if isAuthed()
        && resource.data.teamUid is string
        && resource.data.teamUid == myUid();

      allow create, update, delete: if false;
    }

    // ----------------------
    // tournaments（既存方針維持）
    // ----------------------
    match /tournaments/{tournamentId} {
      allow read: if isAuthed();
      allow create, update, delete: if isGlobalAdmin();

      match /teams/{teamId} {
        allow read: if isAuthed(); // 参照だけなら全員可でもよいが、必要なら制限してください
        allow create, update, delete: if isGlobalAdmin();

        match /players/{playerId} {
          allow read: if isAuthed();
          allow create, update, delete: if isAuthed() && myUid() == teamId;
        }
      }
    }

    // ----------------------
    // matches（P1：全ログインユーザーが参照）
    // ----------------------
    match /matches/{matchId} {

      // 作成/更新/削除は管理者のみ
      allow create, update, delete: if isGlobalAdmin();

      // 参照は全ログインユーザー
      allow read: if isAuthed();

      // memberships
      // - 参照は全ログインユーザー（チーム名表示のため）
      // - 作成は admin または 自分の team membership（inviteId 必須）
      // - 更新/削除は admin のみ
      match /memberships/{uid} {
        allow read: if isAuthed();

        allow create: if isGlobalAdmin()
          || (isAuthed()
            && myUid() == uid
            && request.resource.data.role == "team"
            && request.resource.data.inviteId is string
          );

        allow update, delete: if isGlobalAdmin();
      }

      // teams/{teamId}/players
      // - read: 全ログインユーザー（ログ表示で名前/背番号を引くため）
      // - write: チーム本人（参加者）または admin
      match /teams/{teamId}/players/{playerId} {
        allow read: if isAuthed();
        allow create, update, delete: if (isAuthed() && myUid() == teamId && isParticipant(matchId)) || isGlobalAdmin();
      }

      // events
      // - read: 全ログインユーザー
      // - create: 参加者で、自分が作成者、teamId==自分
      // - update/delete: admin または 作成者本人
      match /events/{eventId} {
        allow read: if isAuthed();

        allow create: if isParticipant(matchId)
          && request.resource.data.createdBy == myUid()
          && request.resource.data.teamId == myUid()
          && request.resource.data.type in ["goal", "callahan"]
          && request.resource.data.timeMs is int;

        allow update: if isGlobalAdmin()
          || (isParticipant(matchId)
            && resource.data.createdBy == myUid()
            && request.resource.data.createdBy == resource.data.createdBy
            && request.resource.data.type in ["goal", "callahan"]
          );

        allow delete: if isGlobalAdmin()
          || (isParticipant(matchId) && resource.data.createdBy == myUid());
      }
    }
  }
}
